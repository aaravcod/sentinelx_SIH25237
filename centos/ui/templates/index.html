<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SentinelX Hardening Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f5; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Professional Theme Colors */
        :root {
            --header-blue: #1e3a5f;
            --header-blue-dark: #152d47;
            --content-gray: #f5f5f5;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent-blue: #2563eb;
            --accent-orange: #f97316;
        }
        
        /* Subtle Glow Effects */
        .glow-text { text-shadow: 0 0 8px rgba(37, 99, 235, 0.3); }
        .glow-box { box-shadow: 0 0 15px rgba(37, 99, 235, 0.1); }
        .glow-fail { text-shadow: 0 0 8px rgba(239, 68, 68, 0.3); }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #e5e5e5; border-left: 1px solid #d0d0d0; }
        ::-webkit-scrollbar-thumb { background: #b0b0b0; border-radius: 5px; border: 2px solid #e5e5e5; }
        ::-webkit-scrollbar-thumb:hover { background: #2563eb; }

        /* Animations */
        @keyframes pulse-scan {
            0% { border-color: #2563eb; box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.5); }
            70% { border-color: #3b82f6; box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
            100% { border-color: #2563eb; box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }
        .animate-scan-pulse { animation: pulse-scan 2s infinite; }
    </style>
</head>
<body class="text-gray-800 h-screen w-screen overflow-hidden flex flex-col" style="background-color: var(--content-gray);">

    <header class="h-16 flex-none border-b border-blue-800 flex items-center justify-between px-6 z-20" style="background-color: var(--header-blue);">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-700 rounded flex items-center justify-center font-bold text-white border border-blue-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            </div>
            <div>
                <h1 class="text-white font-bold tracking-widest text-lg">SENTINELX</h1>
                <p class="text-xs text-blue-200 tracking-wider">Hardening Tool</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-xs text-blue-200 uppercase">OS:</div>
                <div id="os-display" class="text-white font-mono font-bold uppercase tracking-wider">DETECTING...</div>
            </div>
            <div class="h-8 w-px bg-blue-700"></div>
            <!-- <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-mono text-green-500">AGENT ONLINE</span>
            </div> -->
        </div>
    </header>

    <div class="flex-1 grid grid-cols-12 overflow-hidden h-full" style="background-color: var(--content-gray);">
        
        <div class="col-span-3 border-r p-6 flex flex-col relative h-full overflow-y-auto" style="background-color: var(--card-bg); border-color: var(--border-color);">
            
            <div class="mb-10 text-center relative flex-none">
                <div class="w-48 h-48 rounded-full border-8 mx-auto flex items-center justify-center relative" style="border-color: var(--border-color); background-color: var(--content-gray);">
                    <svg class="w-full h-full absolute transform -rotate-90">
                        <circle id="progress-ring" cx="96" cy="96" r="88" stroke="currentColor" stroke-width="8" fill="transparent" class="text-orange-500 transition-all duration-1000" stroke-dasharray="552" stroke-dashoffset="552" />
                    </svg>
                    <div class="z-10 flex flex-col">
                        <span id="score-text" class="text-5xl font-bold tracking-tighter" style="color: var(--accent-orange);">0%</span>
                        <span class="text-xs uppercase mt-1 tracking-widest" style="color: var(--text-secondary);">Compliance</span>
                    </div>
                </div>
                <div class="mt-6 border-t pt-6" style="border-color: var(--border-color);">
                    <button onclick="resetSystem()" class="w-full py-3 bg-transparent border text-red-600 hover:bg-red-50 hover:text-red-700 font-bold text-xs uppercase tracking-widest rounded transition-all" style="border-color: #dc2626;">
                        ⚠️ RESET TO DEFAULTS
                    </button>
                    <p class="text-[10px] text-center mt-2" style="color: var(--text-secondary);">Undoes all changes made by this tool</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-8 flex-none">
                <div class="border p-3 rounded" style="background-color: var(--content-gray); border-color: var(--border-color);">
                    <div class="text-xs uppercase" style="color: var(--text-secondary);">Passing</div>
                    <div id="count-pass" class="text-2xl font-mono font-bold" style="color: var(--text-primary);">0</div>
                </div>
                <div class="border p-3 rounded" style="background-color: var(--content-gray); border-color: #fca5a5;">
                    <div class="text-xs uppercase" style="color: var(--text-secondary);">Critical Fails</div>
                    <div id="count-fail" class="text-2xl font-mono text-red-600 font-bold">0</div>
                </div>
            </div>

            <div class="mb-auto flex-none">
                <label class="text-xs uppercase mb-2 block" style="color: var(--text-secondary);">Hardening Profile</label>
                <select id="profile-select" class="w-full border rounded px-3 py-2" style="background-color: var(--card-bg); border-color: var(--border-color); color: var(--text-primary);">
                    <option value="strict">Strict</option>
                    <option value="moderate">Moderate</option>
                    <option value="basic">Basic</option>
                </select>
            </div>

            <button onclick="startScan()" id="btn-scan" class="flex-none mt-4 w-full py-4 bg-orange-500 hover:bg-orange-600 text-white font-bold text-lg uppercase tracking-widest rounded shadow-lg transition-all transform active:scale-95 border border-orange-600">
                MODERATE LEVEL SCAN
            </button>
            <p class="flex-none text-[10px] text-center mt-3 font-mono" style="color: var(--text-secondary);">ID: SIH-2025-FINAL-BUILD</p>
        </div>

        <div class="col-span-9 flex flex-col relative h-full overflow-hidden" style="background-color: var(--content-gray);">
            <div class="absolute inset-0 pointer-events-none opacity-5" style="background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);"></div>

            <div class="h-12 flex-none border-b flex items-center justify-between px-6 z-10" style="background-color: var(--card-bg); border-color: var(--border-color);">
                <h2 class="text-sm font-bold uppercase tracking-widest" style="color: var(--text-primary);">System Hardening & Compliance</h2>
                <div class="flex gap-2 text-xs font-mono">
                    <button onclick="downloadReport()" class="px-3 py-1 rounded transition hover:bg-gray-100 border" style="background-color: var(--content-gray); border-color: var(--border-color); color: var(--text-primary);">
                        EXPORT PDF
                    </button>
                    <button class="px-3 py-1 rounded transition hover:bg-gray-100 border" style="background-color: var(--content-gray); border-color: var(--border-color); color: var(--text-primary);">VIEW HISTORY</button>
                </div>
            </div>

            <div class="grid grid-cols-12 px-6 py-2 text-xs font-mono uppercase border-b flex-none z-10" style="background-color: var(--card-bg); border-color: var(--border-color); color: var(--text-secondary);">
                <div class="col-span-2">Rule ID</div>
                <div class="col-span-6">Description</div>
                <div class="col-span-2">Severity</div>
                <div class="col-span-2 text-right">Status</div>
            </div>

            <div id="audit-logs" class="flex-1 overflow-y-auto p-4 space-y-1 font-mono text-sm relative" style="background-color: var(--content-gray);">
                <div id="empty-state" class="absolute inset-0 flex items-center justify-center flex-col" style="color: var(--text-secondary);">
                    <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <p class="uppercase tracking-widest text-xs">Waiting for Command</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fixedSessionIds = new Set();

        fetch('/api/status').then(r => r.json()).then(data => {
            document.getElementById('os-display').innerText = data.os;
        });

        function startScan() {
            const btn = document.getElementById('btn-scan');
            const logs = document.getElementById('audit-logs');
            const empty = document.getElementById('empty-state');
            
            // NEW: Get the selected profile
            const profile = document.getElementById('profile-select').value;

            if(empty) empty.style.display = 'none';
            btn.innerHTML = `<span class="animate-pulse">SCANNING (${profile.toUpperCase()})...</span>`;
            
            if(logs.innerHTML.includes("Waiting")) {
                logs.innerHTML = `<div class="animate-pulse font-mono p-4" style="color: var(--accent-blue);">> Initializing Policy Engine [${profile}]...</div>`;
            }
            
            // NEW: Send profile to backend
            fetch(`/api/scan?level=${profile}`)
            .then(r => r.json())
            .then(data => {
                renderTable(data.results);
                btn.innerText = "SCAN COMPLETE";
            });
        }

        function renderTable(results) {
            const container = document.getElementById('audit-logs');
            let html = '';
            let pass = 0, fail = 0;

            // --- NEW: SORT LOGIC (Critical First) ---
            const severityRank = { "Critical": 0, "High": 1, "Medium": 2, "Low": 3 };
            
            results.sort((a, b) => {
                // First sort by Status (FAIL first)
                if (a.status !== b.status) return a.status === 'FAIL' ? -1 : 1;
                // Then sort by Severity
                return (severityRank[a.severity] || 4) - (severityRank[b.severity] || 4);
            });

            results.forEach((item, index) => {
                const isFail = item.status === 'FAIL';
                if(isFail) fail++; else pass++;
                
                const delay = Math.min(index * 30, 2000); // Cap animation delay for 100+ rules

                let actionBtn = '';
                if (isFail) {
                    actionBtn = `<button onclick="fixIssue('${item.id}')" class="text-xs bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded shadow-md font-bold tracking-wider transition-all hover:scale-105">FIX ISSUE</button>`;
                } else if (fixedSessionIds.has(item.id)) {
                    actionBtn = `<button onclick="rollbackIssue('${item.id}')" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded border border-gray-300 transition-all hover:scale-105">UNDO CHANGE</button>`;
                } else {
                    actionBtn = `<span class="text-green-600 font-bold flex items-center justify-end gap-1 text-xs tracking-wider"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> SECURE</span>`;
                }

                html += `
                <div class="grid grid-cols-12 px-4 py-3 rounded border items-center hover:bg-gray-50 transition mb-1 animate-fade-in" style="animation-delay: ${delay}ms; background-color: var(--card-bg); border-color: var(--border-color);">
                    <div class="col-span-2 text-xs font-mono truncate" style="color: var(--text-secondary);" title="${item.id}">${item.id}</div>
                    <div class="col-span-6 font-sans font-medium text-sm truncate" style="color: var(--text-primary);" title="${item.name}">${item.name}</div>
                    <div class="col-span-2">
                        <span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold ${isFail ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                            ${item.severity}
                        </span>
                    </div>
                    <div class="col-span-2 text-right">
                        ${actionBtn}
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            updateStats(pass, fail);
        }

        function fixIssue(id) {
            const btn = event.target;
            btn.innerText = "FIXING...";
            btn.disabled = true;

            fetch('/api/fix', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'fixed') {
                    fixedSessionIds.add(id);
                    startScan(); 
                } else {
                    alert("Fix Failed: " + data.error);
                    btn.innerText = "FIX ISSUE";
                    btn.disabled = false;
                }
            });
        }

        function rollbackIssue(id) {
            if(!confirm("Are you sure you want to revert this change?")) return;

            fetch('/api/rollback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'rolled_back') {
                    fixedSessionIds.delete(id);
                    startScan();
                } else {
                    alert("Rollback Failed: " + data.error);
                }
            });
        }

        function updateStats(pass, fail) {
            document.getElementById('count-pass').innerText = pass;
            document.getElementById('count-pass').style.color = 'var(--text-primary)';
            document.getElementById('count-fail').innerText = fail;
            
            const total = pass + fail;
            const percent = total === 0 ? 0 : Math.round((pass / total) * 100);
            
            document.getElementById('score-text').innerText = percent + "%";
            
            const circle = document.getElementById('progress-ring');
            const circumference = 552;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            if(percent < 50) {
                circle.classList.remove('text-orange-500');
                circle.classList.add('text-red-600');
            } else {
                circle.classList.add('text-orange-500');
                circle.classList.remove('text-red-600');
            }
        }
    function downloadReport() {
        const profile = document.getElementById('profile-select').value;
    // Open the URL with the query parameter
    window.location.href = `/api/export?level=${profile}`;
}
// 6. MASTER RESET Function
        function resetSystem() {
            if(!confirm("WARNING: This will attempt to UNDO ALL changes made by this tool and restore original settings.\n\nAre you sure?")) return;

            const btn = event.target;
            btn.innerText = "RESETTING...";
            btn.disabled = true;

            fetch('/api/reset', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                // Reload page to reflect fresh state
                window.location.reload();
            });
        }
    </script>
</body>
</html>