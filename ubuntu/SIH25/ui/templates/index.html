<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIH 2025 | NTRO Hardening Orchestrator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body class="text-gray-300 h-screen w-screen overflow-hidden flex flex-col bg-black">

    <header class="h-16 flex-none border-b border-gray-800 bg-[#212529] flex items-center justify-between px-6 z-20">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 bg-gradient-to-br from-green-600 to-green-900 rounded flex items-center justify-center font-bold text-white border border-green-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path></svg>
            </div>
            <div>
                <h1 class="text-white font-bold tracking-widest text-lg">HARDENING ORCHESTRATOR</h1>
                <p class="text-xs text-gray-500 tracking-wider">NTRO CYBER SECURITY STANDARD (ANNEXURE A/B)</p>
            </div>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <div class="text-xs text-gray-500 uppercase">System Target</div>
                <div id="os-display" class="text-[#0D6EFD] font-mono font-bold uppercase tracking-wider">DETECTING...</div>
            </div>
            <div class="h-8 w-px bg-gray-800"></div>
            <!-- <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-xs font-mono text-green-500">AGENT ONLINE</span>
            </div> -->
        </div>
    </header>

    <div class="flex-1 grid grid-cols-12 bg-[#F8F9FA] overflow-hidden h-full">
        
        <div class="col-span-3 bg-white border-r border-gray-300 p-6 flex flex-col relative h-full overflow-y-auto">
            
            <div class="mb-10 text-center relative flex-none">
                <div class="w-48 h-48 rounded-full border-8 border-gray-200 mx-auto flex items-center justify-center relative bg-white">
                    <svg class="w-full h-full absolute transform -rotate-90">
                        <circle id="progress-ring" cx="96" cy="96" r="88" stroke="currentColor" stroke-width="8" fill="transparent" class="text-[#FF9800] transition-all duration-1000" stroke-dasharray="552" stroke-dashoffset="552" style="color: #FF9800;" />
                    </svg>
                    <div class="z-10 flex flex-col">
                        <span id="score-text" class="text-5xl font-bold text-[#FF9800] tracking-tighter">0%</span>
                        <span class="text-xs text-gray-500 uppercase mt-1 tracking-widest">Compliance</span>
                    </div>
                </div>
                <div class="mt-6 border-t border-gray-800 pt-6">
                    <button onclick="resetSystem()" class="w-full py-3 bg-transparent border border-red-800 text-red-700 hover:bg-red-900/20 hover:text-red-500 font-bold text-xs uppercase tracking-widest rounded transition-all">
                        ⚠️ RESET TO DEFAULTS
                    </button>
                    <p class="text-[10px] text-gray-600 text-center mt-2">Undoes all changes made by this tool</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-8 flex-none">
                <div class="bg-gray-900 border border-gray-800 p-3 rounded">
                    <div class="text-xs text-gray-500 uppercase">Passing</div>
                    <div id="count-pass" class="text-2xl font-mono text-[#198754] font-bold">0</div>
                </div>
                <div class="bg-gray-900 border border-red-900/30 p-3 rounded">
                    <div class="text-xs text-gray-500 uppercase">Critical Fails</div>
                    <div id="count-fail" class="text-2xl font-mono text-red-500 font-bold glow-fail">0</div>
                </div>
            </div>

            <div class="mb-auto flex-none">
                <label class="text-xs text-gray-500 uppercase mb-2 block">Hardening Profile</label>
                <select id="profile-select" class="w-full bg-gray-900 border border-gray-800 text-gray-300 px-3 py-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="strict">Strict</option>
                    <option value="moderate">Moderate</option>
                    <option value="basic">Basic</option>
                </select>
            </div>

            <button onclick="startScan()" id="btn-scan" class="flex-none mt-4 w-full py-4 bg-[#FF9800] hover:bg-[#FB8C00] text-white font-bold text-lg uppercase tracking-widest rounded shadow-lg transition-all transform active:scale-95 border border-[#FF9800]">
                INITIATE AUDIT
            </button>
            <p class="flex-none text-[10px] text-gray-600 text-center mt-3 font-mono">ID: SIH-2025-FINAL-BUILD</p>
        </div>

        <div class="col-span-9 flex flex-col bg-[#F8F9FA] relative h-full overflow-hidden">
            <div class="absolute inset-0 pointer-events-none bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDAwIiAvPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSIxIiBmaWxsPSJyc2diKDAsIDQwLCAwKSIgb3BhY2l0eT0iMC4yIiAvPjwvc3ZnPg==')] opacity-20"></div>

            <div class="h-12 flex-none border-b border-gray-300 flex items-center justify-between px-6 bg-white">
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest">Live Audit Log</h2>
                <div class="flex gap-2 text-xs font-mono">
                    <button onclick="downloadReport()" class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-gray-300 transition hover:text-white border border-gray-700">
                        EXPORT PDF
                    </button>
                    <button class="px-3 py-1 bg-gray-800 hover:bg-gray-700 rounded text-gray-300">VIEW HISTORY</button>
                </div>
            </div>

            <div class="grid grid-cols-12 px-6 py-2 text-xs font-mono text-gray-600 uppercase border-b border-gray-300 flex-none bg-white z-10">
                <div class="col-span-2">Rule ID</div>
                <div class="col-span-6">Description</div>
                <div class="col-span-2">Severity</div>
                <div class="col-span-2 text-right">Status</div>
            </div>

            <div id="audit-logs" class="flex-1 overflow-y-auto p-4 space-y-1 font-mono text-sm relative">
                <div id="empty-state" class="absolute inset-0 flex items-center justify-center flex-col text-gray-700">
                    <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <p class="uppercase tracking-widest text-xs">Waiting for Command</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fixedSessionIds = new Set();

        fetch('/api/status').then(r => r.json()).then(data => {
            document.getElementById('os-display').innerText = data.os;
        });

        function startScan() {
            const btn = document.getElementById('btn-scan');
            const logs = document.getElementById('audit-logs');
            const empty = document.getElementById('empty-state');
            
            // NEW: Get the selected profile
            const profile = document.getElementById('profile-select').value;

            if(empty) empty.style.display = 'none';
            btn.innerHTML = `<span class="animate-pulse">SCANNING (${profile.toUpperCase()})...</span>`;
            
            if(logs.innerHTML.includes("Waiting")) {
                logs.innerHTML = `<div class="text-[#0D6EFD] animate-pulse font-mono p-4">> Initializing Policy Engine [${profile}]...</div>`;
            }
            
            // NEW: Send profile to backend
            fetch(`/api/scan?level=${profile}`)
            .then(r => r.json())
            .then(data => {
                renderTable(data.results);
                btn.innerText = "SCAN COMPLETE";
            });
        }

        function renderTable(results) {
            const container = document.getElementById('audit-logs');
            let html = '';
            let pass = 0, fail = 0;

            // --- NEW: SORT LOGIC (Critical First) ---
            const severityRank = { "Critical": 0, "High": 1, "Medium": 2, "Low": 3 };
            
            results.sort((a, b) => {
                // First sort by Status (FAIL first)
                if (a.status !== b.status) return a.status === 'FAIL' ? -1 : 1;
                // Then sort by Severity
                return (severityRank[a.severity] || 4) - (severityRank[b.severity] || 4);
            });

            results.forEach((item, index) => {
                const isFail = item.status === 'FAIL';
                if(isFail) fail++; else pass++;
                
                const delay = Math.min(index * 30, 2000); // Cap animation delay for 100+ rules

                let actionBtn = '';
                if (isFail) {
                    actionBtn = `<button onclick="fixIssue('${item.id}')" class="text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded shadow-lg shadow-red-900/50 font-bold tracking-wider transition-all hover:scale-105">FIX ISSUE</button>`;
                } else if (fixedSessionIds.has(item.id)) {
                    actionBtn = `<button onclick="rollbackIssue('${item.id}')" class="text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 px-3 py-1 rounded border border-gray-600 transition-all hover:scale-105">UNDO CHANGE</button>`;
                } else {
                    actionBtn = `<span class="text-[#198754] font-bold flex items-center justify-end gap-1 text-xs tracking-wider"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> SECURE</span>`;
                }

                html += `
                <div class="grid grid-cols-12 px-4 py-3 rounded border border-gray-200 bg-white items-center hover:bg-gray-50 transition mb-1 animate-fade-in" style="animation-delay: ${delay}ms">
                    <div class="col-span-2 text-gray-600 text-xs font-mono truncate" title="${item.id}">${item.id}</div>
                    <div class="col-span-6 text-gray-900 font-sans font-medium text-sm truncate" title="${item.name}">${item.name}</div>
                    <div class="col-span-2">
                        <span class="px-2 py-0.5 rounded text-[10px] uppercase font-bold ${isFail ? 'bg-red-900/30 text-red-500' : 'bg-green-900/30 text-green-500'}">
                            ${item.severity}
                        </span>
                    </div>
                    <div class="col-span-2 text-right">
                        ${actionBtn}
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            updateStats(pass, fail);
        }

        function fixIssue(id) {
            const btn = event.target;
            btn.innerText = "FIXING...";
            btn.disabled = true;

            fetch('/api/fix', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'fixed') {
                    fixedSessionIds.add(id);
                    startScan(); 
                } else {
                    alert("Fix Failed: " + data.error);
                    btn.innerText = "FIX ISSUE";
                    btn.disabled = false;
                }
            });
        }

        function rollbackIssue(id) {
            if(!confirm("Are you sure you want to revert this change?")) return;

            fetch('/api/rollback', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            })
            .then(r => r.json())
            .then(data => {
                if(data.status === 'rolled_back') {
                    fixedSessionIds.delete(id);
                    startScan();
                } else {
                    alert("Rollback Failed: " + data.error);
                }
            });
        }

        function updateStats(pass, fail) {
            document.getElementById('count-pass').innerText = pass;
            document.getElementById('count-pass').classList.add('text-[#198754]');
            document.getElementById('count-fail').innerText = fail;
            
            const total = pass + fail;
            const percent = total === 0 ? 0 : Math.round((pass / total) * 100);
            
            document.getElementById('score-text').innerText = percent + "%";
            
            const circle = document.getElementById('progress-ring');
            const circumference = 552;
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
            
            if(percent < 50) {
                circle.style.color = '#DC3545';
            } else {
                circle.style.color = '#FF9800';
            }
        }
    function downloadReport() {
        const profile = document.getElementById('profile-select').value;
    // Open the URL with the query parameter
    window.location.href = `/api/export?level=${profile}`;
}
// 6. MASTER RESET Function
        function resetSystem() {
            if(!confirm("WARNING: This will attempt to UNDO ALL changes made by this tool and restore original settings.\n\nAre you sure?")) return;

            const btn = event.target;
            btn.innerText = "RESETTING...";
            btn.disabled = true;

            fetch('/api/reset', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                // Reload page to reflect fresh state
                window.location.reload();
            });
        }
    </script>
</body>
</html>